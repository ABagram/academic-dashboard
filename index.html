<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css" rel="stylesheet"></link>
</head>
<body>
    <div>
        <h1>Academic Dashboard</h1>
        <nav>
            <ul>
                <li><a href="#home" class="tab-link" data-tab="home">Home</a></li>
                <li><a href="#program-overview" class="tab-link" data-tab="program-overview">Program Overview</a></li>
                <li><a href="#program-flowchart" class="tab-link" data-tab="program-flowchart">Program Flowchart</a></li>
                <li><a href="#study-room" class="tab-link" data-tab="study-room">Study Room</a></li>
                <li><a href="#focus" class="tab-link" data-tab="focus">Focus</a></li>
            </ul>
        </nav>
        <div class="tab-content" id="home">
            <div id="current-time-date">
                <span id="current-time"></span>
                <div id="date-day-container">
                    <span id="current-date"></span>
                    <span id="current-day"></span> <!-- Add a new span for the day of the week -->
                </div>
            </div>
            <h2>Schedule</h2>
            <!-- Add current week panel -->
            <div id="current-week-panel">
                <h3>Current Week</h3>
                <table id="week-table">
                    <thead>
                        <tr>
                            <th>Week No.</th>
                            <th>Start</th>
                            <th>End</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td><input type="date" class="week-start"></td>
                            <td><input type="date" class="week-end"></td>
                        </tr>
                        <!-- Additional rows can be added dynamically -->
                    </tbody>
                </table>
                <button id="add-week-btn">Add Week</button>
            </div>
            <div id="current-week-number">
                <h3>Current Week Number: <span id="week-number">N/A</span></h3>
            </div>
            <!-- Add new table for course requirements -->
            <h2>Course Requirements</h2>
            <table id="requirements-table">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Course Code</th>
                        <th>Requirement</th>
                        <th>Description</th>
                        <th>Due Date</th>
                        <th>Day</th>
                        <th>Start Time</th>
                        <th>Due Time</th>
                        <th>Time Left</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows can be added dynamically -->
                </tbody>
            </table>
            <button id="add-requirement-btn">Add Requirement</button> <!-- Button to add new rows -->
        </div>
        <div class="tab-content" id="program-overview">
            <button id="add-academic-period-btn">Add Academic Period</button>
            <div id="academic-periods-container">
                <!-- Academic periods will be dynamically added here -->
            </div>
            <!-- Move year table here -->
            <div class="term-details">
                <h3 id="term-details-header">Academic Program Calendar</h3>
                <button id="edit-term-columns-btn">Edit Columns</button>
                <div id="term-columns-checklist" style="display: none;">
                    <label><input type="checkbox" value="start-date" checked> Start Date</label>
                    <label><input type="checkbox" value="end-date" checked> End Date</label>
                    <label><input type="checkbox" value="units" checked> No. of Units</label>
                    <label><input type="checkbox" value="gpa" checked> GPA</label>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th id="year-no-header">Year</th>
                            <th class="start-date">Start Date</th>
                            <th class="end-date">End Date</th>
                            <th class="units">No. of Units</th>
                            <th class="gpa">GPA</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td class="start-date"><input type="month" placeholder="Start Date"></td>
                            <td class="end-date"><input type="month" placeholder="End Date"></td>
                            <td class="units"><input type="number" step="0.01" placeholder="Units"></td>
                            <td class="gpa"><input type="number" step="0.01" placeholder="GPA"></td>
                        </tr>
                        <!-- Additional rows can be added dynamically -->
                    </tbody>
                </table>
                <button id="add-term-btn">Add Year</button>
                <label for="cgpa">Cumulative GPA (CGPA):</label>
                <input type="number" id="cgpa" step="0.01" placeholder="Enter CGPA">
            </div>
        </div>
        <div class="tab-content" id="program-flowchart">
            <div class="program-card">
                <div id="program-name" placeholder="Program Name"></div>
                <div id="program-code" placeholder="Program Code"></div>
                <select id="program-level">
                    <option value="undergraduate">Undergraduate</option>
                    <option value="graduate">Graduate</option>
                    <option value="post-graduate">Post-Graduate</option>
                </select>
            </div>
            <!-- Move program overview content here -->
            <h2>Program Overview</h2>
            <div class="select-menu" id="program-type">

                <div class="select-btn">
                    <span class="sBtn-text">Select Program Type</span>
                    <i class="bx bx-chevron-down"></i>
                </div>

                <ul class="options">
                    <li class="option">
                        <span class="option-text">Semestral</span>
                    </li>
                    <li class="option">
                        <span class="option-text">Trimestral</span>
                    </li>
                    <li class="option">
                        <span class="option-text">Quarterly</span>
                    </li>
                </ul>
            </div>
            
            <label for="total-terms">Total:</label>
            <input type="number" id="total-terms" min="1">
            
            <label for="program-start-date">Program Start Date:</label>
            <input type="month" id="program-start-date" placeholder="Enter start date">
            
            <div id="course-tables-container">
                <h3>All Courses</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Term Taken</th>
                            <th>Flowchart</th>
                            <th>Course Code</th>
                            <th>Course Title</th>
                            <th>Units</th>
                            <th>Pre-requisites</th> <!-- Add pre-requisites column -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Course rows will be dynamically added here -->
                    <tbody>
                        <!-- Course rows will be dynamically added here -->
                    </tbody>
                </table>
                <button id="add-all-courses-btn" class="add-course-btn">Add Course</button>
            </div>
        </div>
        <div class="tab-content" id="study-room">
            <!-- Study Room content goes here -->
        </div>
        <div class="tab-content" id="focus">
            <h2>Pomodoro Timer</h2>
            <div id="pomodoro-timer">
                <span id="timer">25:00</span>
                <button id="start-timer-btn">Start</button>
                <button id="reset-timer-btn">Reset</button>
            </div>
            <h3>Blocked Sites</h3>
            <label for="blocked-sites">Enter sites to block (comma-separated):</label>
            <input type="text" id="blocked-sites" placeholder="e.g., facebook.com, youtube.com">
            <button id="block-sites-btn">Block Sites</button>
        </div>
        <div class="display-options">
            <button class="display-option-btn" id="toggle-main-container-btn">
                <span class="plus-icon">+</span> Current Semester Schedule
            </button>
        </div>
    </div>
    <div class="course-input-container">
        <button id="add-course-btn">Add Course</button>
        <button id="toggle-view-btn">Table View</button>
        <div id="course-cards-container">
            <!-- Example course card structure -->
            <div class="course-card">
                <div class="course-details">
                    <div class="course-code-section">
                        <div class="editable course-code" data-placeholder="Enter course code"></div>
                        <div class="editable course-section" data-placeholder="Enter course section"></div>
                    </div>
                    <div class="editable" data-placeholder="Enter course title"></div>
                    <div class="editable" data-placeholder="Enter location"></div>
                    <div class="editable" data-placeholder="Enter grade"></div>
                    <div class="editable" data-placeholder="Enter unit"></div>
                </div>
                <div class="schedule-details">
                    <div class="days-checkboxes">
                        <input type="checkbox" id="sunday-example" name="days" value="Sunday"><label for="sunday-example">Su</label>
                        <input type="checkbox" id="monday-example" name="days" value="Monday"><label for="monday-example">M</label>
                        <input type="checkbox" id="tuesday-example" name="days" value="Tuesday"><label for="tuesday-example">Tu</label>
                        <input type="checkbox" id="wednesday-example" name="days" value="Wednesday"><label for="wednesday-example">W</label>
                        <input type="checkbox" id="thursday-example" name="days" value="Thursday"><label for="thursday-example">Th</label>
                        <input type="checkbox" id="friday-example" name="days" value="Friday"><label for="friday-example">F</label>
                        <input type="checkbox" id="saturday-example" name="days" value="Saturday"><label for="saturday-example">Sa</label>
                    </div>
                    <div>
                        <label><input type="checkbox" id="same-time-checkbox-example"> Same time for all days</label>
                    </div>
                    <div id="time-inputs-example" class="time-inputs"></div>
                </div>
                <button class="delete-course-btn">Delete</button>
            </div>
        </div>
        <div id="course-table-container">
            <!-- Course table will be dynamically added here -->
        </div>
    </div>
    <div class="canvas-container"></div>
    <div class="calendar-size-inputs">
        <label for="device-select">Device:</label>
        <select id="device-select"></select>
        <label for="calendar-width">Width:</label>
        <input type="number" id="calendar-width" min="100" value="375" disabled>
        <label for="calendar-height">Height:</label>
        <input type="number" id="calendar-height" min="100" value="667" disabled>
        <label><input type="checkbox" id="override-days-checkbox"> Override selected days</label>
    </div>
    <div id="main-container">
        <div id="course-cards-container"></div>
        <div id="calendar-container"></div>
    </div>
    <div id="table">
        <!-- Dynamically generated main-container divs will be appended here -->
    </div>
    <div id="timezone-selector" style="display: none; position: absolute; background: white; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
        <label for="timezone">Select Timezone:</label>
        <select id="timezone"></select> <!-- Timezone options will be loaded dynamically -->
    </div>
    <script>
        function updateCalendar() {
            const calendarContainer = document.getElementById('calendar-container');
            const overrideDays = document.getElementById('override-days-checkbox').checked;
            const courses = document.querySelectorAll('.course-card');
            let earliestStartTime = '23:59';
            let latestEndTime = '00:00';

            courses.forEach(course => {
                const startTimes = course.querySelectorAll('.start-time');
                const endTimes = course.querySelectorAll('.end-time');

                startTimes.forEach(startTimeInput => {
                    if (startTimeInput.value && startTimeInput.value < earliestStartTime) {
                        earliestStartTime = startTimeInput.value;
                    }
                });

                endTimes.forEach(endTimeInput => {
                    if (endTimeInput.value && endTimeInput.value > latestEndTime) {
                        latestEndTime = endTimeInput.value;
                    }
                });
            });

            calendarContainer.innerHTML = `
                <div class="calendar-header">
                    <div class="calendar-time"></div>
                    <div class="calendar-day">Sunday</div>
                    <div class="calendar-day">Monday</div>
                    <div class="calendar-day">Tuesday</div>
                    <div class="calendar-day">Wednesday</div>
                    <div class="calendar-day">Thursday</div>
                    <div class="calendar-day">Friday</div>
                    <div class="calendar-day">Saturday</div>
                </div>
            `;

            const timeRange = getTimeRange(earliestStartTime, latestEndTime);
            const rowHeight = document.getElementById('calendar-height').value / timeRange.length;
            timeRange.forEach(time => {
                const timeRow = document.createElement('div');
                timeRow.className = 'calendar-row';
                timeRow.style.height = `${rowHeight}px`;
                timeRow.innerHTML = `<div class="calendar-time">${time}</div>`;
                for (let i = 0; i < 7; i++) {
                    timeRow.innerHTML += `<div class="calendar-cell"></div>`;
                }
                calendarContainer.appendChild(timeRow);
            });

            if (!overrideDays) {
                courses.forEach(course => {
                    const courseCode = course.querySelector('.course-code').textContent.trim();
                    const days = course.querySelectorAll('input[name="days"]:checked');
                    days.forEach(day => {
                        const dayIndex = getDayIndex(day.value);
                        const startTime = course.querySelector(`input[name="${day.value.toLowerCase()}-start-time"]`).value;
                        const endTime = course.querySelector(`input[name="${day.value.toLowerCase()}-end-time"]`).value;
                        if (startTime && endTime) {
                            const courseDiv = document.createElement('div');
                            courseDiv.className = 'calendar-course';
                            courseDiv.innerHTML = `
                                <div class="course-time start-time">${startTime}</div>
                                <div class="course-code">${courseCode}</div>
                                <div class="course-time end-time">${endTime}</div>
                            `;
                            const startRow = getTimeRowIndex(startTime, earliestStartTime);
                            const endRow = getTimeRowIndex(endTime, earliestStartTime);
                            const startOffset = getTimeOffset(startTime);
                            const endOffset = getTimeOffset(endTime);
                            courseDiv.style.top = `${startOffset * 100}%`;
                            courseDiv.style.height = `${(endRow - startRow + endOffset - startOffset) * 100}%`;
                            calendarContainer.children[startRow + 1].children[dayIndex + 1].appendChild(courseDiv);
                        }
                    });
                });
            }
        }

        function getTimeRange(start, end) {
            const times = [];
            let currentTime = new Date(`1970-01-01T${start}Z`);
            const endTime = new Date(`1970-01-01T${end}Z`);
            while (currentTime <= endTime) {
                times.push(currentTime.toISOString().substr(11, 5).slice(0, 2) + ':00');
                currentTime.setHours(currentTime.getHours() + 1);
            }
            return times;
        }

        function getDayIndex(day) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days.indexOf(day);
        }

        function getTimeRowIndex(time, start) {
            const startTime = new Date(`1970-01-01T${start}Z`);
            const currentTime = new Date(`1970-01-01T${time}Z`);
            return Math.floor((currentTime - startTime) / (60 * 60000));
        }

        function getTimeOffset(time) {
            const [hours, minutes] = time.split(':').map(Number);
            return (minutes / 60);
        }

        function saveToLocalStorage() {
            const courses = Array.from(document.querySelectorAll('.course-card')).map(course => {
                const courseCode = course.querySelector('.course-code').textContent.trim();
                const courseSection = course.querySelector('.course-section').textContent.trim();
                const courseTitle = course.querySelector('.editable[data-placeholder="Course Title"]').textContent.trim();
                const location = course.querySelector('.editable[data-placeholder="Location / Room No. / Room Code"]').textContent.trim();
                const days = Array.from(course.querySelectorAll('input[name="days"]:checked')).map(checkbox => checkbox.value);
                const sameTime = course.querySelector('input[id^="same-time-checkbox"]').checked;
                const times = Array.from(course.querySelectorAll('.time-input')).map(input => ({
                    day: input.querySelector('span').textContent,
                    startTime: input.querySelector('.start-time').value,
                    endTime: input.querySelector('.end-time').value
                }));
                return { courseCode, courseSection, courseTitle, location, days, sameTime, times };
            });

            const calendarWidth = document.getElementById('calendar-width').value;
            const calendarHeight = document.getElementById('calendar-height').value;
            const overrideDays = document.getElementById('override-days-checkbox').checked;
            const deviceSelect = document.getElementById('device-select').value;

            localStorage.setItem('courses', JSON.stringify(courses));
            localStorage.setItem('calendarWidth', calendarWidth);
            localStorage.setItem('calendarHeight', calendarHeight);
            localStorage.setItem('overrideDays', overrideDays);
            localStorage.setItem('deviceSelect', deviceSelect);
        }

        function loadFromLocalStorage() {
            const courses = JSON.parse(localStorage.getItem('courses')) || [];
            const calendarWidth = localStorage.getItem('calendarWidth') || 375;
            const calendarHeight = localStorage.getItem('calendarHeight') || 667;
            const overrideDays = JSON.parse(localStorage.getItem('overrideDays')) || false;
            const deviceSelect = localStorage.getItem('deviceSelect') || '375x667';

            document.getElementById('calendar-width').value = calendarWidth;
            document.getElementById('calendar-height').value = calendarHeight;
            document.getElementById('override-days-checkbox').checked = overrideDays;
            document.getElementById('device-select').value = deviceSelect;

            const cardsContainer = document.getElementById('course-cards-container');
            courses.forEach(course => {
                const uniqueId = Date.now();
                const newCard = document.createElement('div');
                newCard.className = 'course-card';
                newCard.innerHTML = `
                    <div class="course-details">
                        <div class="course-code-section">
                            <div class="editable course-code" data-placeholder="Course Code">${course.courseCode}</div>
                            <div class="editable course-section" data-placeholder="Course Section">${course.courseSection}</div>
                        </div>
                        <div class="editable" data-placeholder="Course Title">${course.courseTitle}</div>
                        <div class="editable" data-placeholder="Location / Room No. / Room Code">${course.location}</div>
                    </div>
                    <div class="schedule-details">
                        <div class="days-checkboxes">
                            ${['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'].map(day => `
                                <input type="checkbox" id="${day.toLowerCase()}-${uniqueId}" name="days" value="${day}" ${course.days.includes(day) ? 'checked' : ''}><label for="${day.toLowerCase()}-${uniqueId}">${day.slice(0, 2)}</label>
                            `).join('')}
                        </div>
                        <div>
                            <label><input type="checkbox" id="same-time-checkbox-${uniqueId}" ${course.sameTime ? 'checked' : ''}> Same time for all days</label>
                        </div>
                        <div id="time-inputs-${uniqueId}" class="time-inputs">
                            ${course.times.map(time => `
                                <div class="time-input">
                                    <span>${time.day}</span>
                                    <input type="time" name="${time.day.toLowerCase()}-start-time" class="start-time" value="${time.startTime}">
                                    <input type="time" name="${time.day.toLowerCase()}-end-time" class="end-time" value="${time.endTime}">
                                    <span class="duration"></span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <button class="delete-course-btn">Delete</button>
                `;
                cardsContainer.appendChild(newCard);

                const sameTimeCheckbox = newCard.querySelector(`#same-time-checkbox-${uniqueId}`);
                const dayCheckboxes = newCard.querySelectorAll('input[name="days"]');
                const timeInputsContainer = newCard.querySelector(`#time-inputs-${uniqueId}`);

                function updateTimeInputs() {
                    if (sameTimeCheckbox.checked) {
                        timeInputsContainer.innerHTML = '';
                        const selectedDays = Array.from(dayCheckboxes).filter(checkbox => checkbox.checked).map(checkbox => checkbox.value).join(', ');
                        if (selectedDays) {
                            timeInputsContainer.innerHTML = `
                                <div class="time-input">
                                    <span>${selectedDays}</span>
                                    <input type="time" name="start-time" class="start-time">
                                    <input type="time" name="end-time" class="end-time">
                                    <span class="duration"></span>
                                </div>
                            `;
                        }
                    } else {
                        timeInputsContainer.innerHTML = '';
                        dayCheckboxes.forEach(checkbox => {
                            if (checkbox.checked) {
                                const day = checkbox.value;
                                timeInputsContainer.innerHTML += `
                                    <div class="time-input">
                                        <span>${day}</span>
                                        <input type="time" name="${day.toLowerCase()}-start-time" class="start-time">
                                        <input type="time" name="${day.toLowerCase()}-end-time" class="end-time">
                                        <span class="duration"></span>
                                    </div>
                                `;
                            }
                        });
                    }
                    addDurationListeners();
                    updateCalendar();
                }

                function addDurationListeners() {
                    const timeInputs = newCard.querySelectorAll('.time-input');
                    timeInputs.forEach(input => {
                        const startTimeInput = input.querySelector('.start-time');
                        const endTimeInput = input.querySelector('.end-time');
                        const durationSpan = input.querySelector('.duration');

                        function calculateDuration() {
                            const startTime = startTimeInput.value;
                            const endTime = endTimeInput.value;
                            if (startTime && endTime) {
                                const start = new Date(`1970-01-01T${startTime}Z`);
                                const end = new Date(`1970-01-01T${endTime}Z`);
                                const diff = (end - start) / 60000; // difference in minutes
                                const hours = Math.floor(diff / 60);
                                const minutes = diff % 60;
                                durationSpan.textContent = `${hours}h ${minutes}m`;
                            } else {
                                durationSpan.textContent = '';
                            }
                        }

                        startTimeInput.addEventListener('input', calculateDuration);
                        endTimeInput.addEventListener('input', calculateDuration);
                    });
                }

                sameTimeCheckbox.addEventListener('change', updateTimeInputs);
                dayCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', updateTimeInputs);
                });

                // Make divs editable on double-click
                newCard.querySelectorAll('.editable').forEach(div => {
                    div.addEventListener('dblclick', function() {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = div.textContent.trim();
                        input.placeholder = div.getAttribute('data-placeholder');
                        input.style.fontSize = window.getComputedStyle(div).fontSize;
                        input.style.fontWeight = window.getComputedStyle(div).fontWeight;
                        div.textContent = '';
                        div.appendChild(input);
                        input.focus();

                        input.addEventListener('blur', function() {
                            div.textContent = input.value.trim() || input.placeholder;
                            div.removeChild(input);
                        });

                        input.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                input.blur();
                            }
                        });
                    });
                });

                // Add right-click event to show delete button
                newCard.addEventListener('contextmenu', function(event) {
                    event.preventDefault();
                    const deleteBtn = newCard.querySelector('.delete-course-btn');
                    deleteBtn.style.display = 'block';

                    document.addEventListener('click', function hideDeleteButton(e) {
                        if (!newCard.contains(e.target)) {
                            deleteBtn.style.display = 'none';
                            document.removeEventListener('click', hideDeleteButton);
                        }
                    });
                });

                // Add click event to delete button
                newCard.querySelector('.delete-course-btn').addEventListener('click', function() {
                    cardsContainer.removeChild(newCard);
                    updateCalendar();
                    saveToLocalStorage();
                });

                updateCalendar();
            });
        }

        function saveProgramDetailsToLocalStorage() {
            const programName = document.getElementById('program-name').textContent.trim() || '';
            const programCode = document.getElementById('program-code').textContent.trim() || '';
            const programType = document.getElementById('program-type').value || '';
            const totalTerms = document.getElementById('total-terms').value || '';
            const programStartDate = document.getElementById('program-start-date').value || '';

            localStorage.setItem('programName', programName);
            localStorage.setItem('programCode', programCode);
            localStorage.setItem('programType', programType);
            localStorage.setItem('totalTerms', totalTerms);
            localStorage.setItem('programStartDate', programStartDate);
        }

        function loadProgramDetailsFromLocalStorage() {
            const programName = localStorage.getItem('programName') || '';
            const programCode = localStorage.getItem('programCode') || '';
            const programType = localStorage.getItem('programType') || 'semestral';
            const totalTerms = localStorage.getItem('totalTerms') || '';
            const programStartDate = localStorage.getItem('programStartDate') || '';

            document.getElementById('program-name').textContent = programName;
            document.getElementById('program-code').textContent = programCode;
            document.getElementById('program-type').value = programType;
            document.getElementById('total-terms').value = totalTerms;
            document.getElementById('program-start-date').value = programStartDate;
        }

        document.getElementById('program-name').addEventListener('blur', saveProgramDetailsToLocalStorage);
        document.getElementById('program-code').addEventListener('blur', saveProgramDetailsToLocalStorage);
        document.getElementById('program-type').addEventListener('change', saveProgramDetailsToLocalStorage);
        document.getElementById('total-terms').addEventListener('input', saveProgramDetailsToLocalStorage);
        document.getElementById('program-start-date').addEventListener('input', saveProgramDetailsToLocalStorage);

        document.addEventListener('DOMContentLoaded', function() {
            loadProgramDetailsFromLocalStorage();
            loadFromLocalStorage();
        });

        document.getElementById('add-course-btn').addEventListener('click', function() {
            const cardsContainer = document.getElementById('course-cards-container');
            const uniqueId = Date.now();
            const newCard = document.createElement('div');
            newCard.className = 'course-card';
            newCard.innerHTML = `
                <div class="course-details">
                    <div class="course-code-section">
                        <div class="editable course-code" data-placeholder="Enter course code"></div>
                        <div class="editable course-section" data-placeholder="Enter course section"></div>
                    </div>
                    <div class="editable" data-placeholder="Enter course title"></div>
                    <div class="editable" data-placeholder="Enter location"></div>
                    <div class="editable" data-placeholder="Enter grade"></div>
                    <div class="editable" data-placeholder="Enter unit"></div>
                </div>
                <div class="schedule-details">
                    <div class="days-checkboxes">
                        <input type="checkbox" id="sunday-${uniqueId}" name="days" value="Sunday"><label for="sunday-${uniqueId}">Su</label>
                        <input type="checkbox" id="monday-${uniqueId}" name="days" value="Monday"><label for="monday-${uniqueId}">M</label>
                        <input type="checkbox" id="tuesday-${uniqueId}" name="days" value="Tuesday"><label for="tuesday-${uniqueId}">Tu</label>
                        <input type="checkbox" id="wednesday-${uniqueId}" name="days" value="Wednesday"><label for="wednesday-${uniqueId}">W</label>
                        <input type="checkbox" id="thursday-${uniqueId}" name="days" value="Thursday"><label for="thursday-${uniqueId}">Th</label>
                        <input type="checkbox" id="friday-${uniqueId}" name="days" value="Friday"><label for="friday-${uniqueId}">F</label>
                        <input type="checkbox" id="saturday-${uniqueId}" name="days" value="Saturday"><label for="saturday-${uniqueId}">Sa</label>
                    </div>
                    <div>
                        <label><input type="checkbox" id="same-time-checkbox-${uniqueId}"> Same time for all days</label>
                    </div>
                    <div id="time-inputs-${uniqueId}" class="time-inputs"></div>
                </div>
                <button class="delete-course-btn">Delete</button>
            `;
            cardsContainer.appendChild(newCard);

            const sameTimeCheckbox = newCard.querySelector(`#same-time-checkbox-${uniqueId}`);
            const dayCheckboxes = newCard.querySelectorAll('input[name="days"]');
            const timeInputsContainer = newCard.querySelector(`#time-inputs-${uniqueId}`);

            function updateTimeInputs() {
                if (sameTimeCheckbox.checked) {
                    timeInputsContainer.innerHTML = '';
                    const selectedDays = Array.from(dayCheckboxes).filter(checkbox => checkbox.checked).map(checkbox => checkbox.value).join(', ');
                    if (selectedDays) {
                        timeInputsContainer.innerHTML = `
                            <div class="time-input">
                                <span>${selectedDays}</span>
                                <input type="time" name="start-time" class="start-time">
                                <input type="time" name="end-time" class="end-time">
                                <span class="duration"></span>
                            </div>
                        `;
                    }
                } else {
                    timeInputsContainer.innerHTML = '';
                    dayCheckboxes.forEach(checkbox => {
                        if (checkbox.checked) {
                            const day = checkbox.value;
                            timeInputsContainer.innerHTML += `
                                <div class="time-input">
                                    <span>${day}</span>
                                    <input type="time" name="${day.toLowerCase()}-start-time" class="start-time">
                                    <input type="time" name="${day.toLowerCase()}-end-time" class="end-time">
                                    <span class="duration"></span>
                                </div>
                            `;
                        }
                    });
                }
                addDurationListeners();
                updateCalendar();
            }

            function addDurationListeners() {
                const timeInputs = newCard.querySelectorAll('.time-input');
                timeInputs.forEach(input => {
                    const startTimeInput = input.querySelector('.start-time');
                    const endTimeInput = input.querySelector('.end-time');
                    const durationSpan = input.querySelector('.duration');

                    function calculateDuration() {
                        const startTime = startTimeInput.value;
                        const endTime = endTimeInput.value;
                        if (startTime && endTime) {
                            const start = new Date(`1970-01-01T${startTime}Z`);
                            const end = new Date(`1970-01-01T${endTime}Z`);
                            const diff = (end - start) / 60000; // difference in minutes
                            const hours = Math.floor(diff / 60);
                            const minutes = diff % 60;
                            durationSpan.textContent = `${hours}h ${minutes}m`;
                        } else {
                            durationSpan.textContent = '';
                        }
                    }

                    startTimeInput.addEventListener('input', calculateDuration);
                    endTimeInput.addEventListener('input', calculateDuration);
                });
            }

            sameTimeCheckbox.addEventListener('change', updateTimeInputs);
            dayCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateTimeInputs);
            });

            // Make divs editable on double-click
            newCard.querySelectorAll('.editable').forEach(div => {
                div.addEventListener('dblclick', function() {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = div.textContent.trim();
                    input.placeholder = div.getAttribute('data-placeholder');
                    input.style.fontSize = window.getComputedStyle(div).fontSize;
                    input.style.fontWeight = window.getComputedStyle(div).fontWeight;
                    div.textContent = '';
                    div.appendChild(input);
                    input.focus();

                    input.addEventListener('blur', function() {
                        div.textContent = input.value.trim() || input.placeholder;
                        div.removeChild(input);
                    });

                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            input.blur();
                        }
                    });
                });
            });

            // Add right-click event to show delete button
            newCard.addEventListener('contextmenu', function(event) {
                event.preventDefault();
                const deleteBtn = newCard.querySelector('.delete-course-btn');
                deleteBtn.style.display = 'block';

                document.addEventListener('click', function hideDeleteButton(e) {
                    if (!newCard.contains(e.target)) {
                        deleteBtn.style.display = 'none';
                        document.removeEventListener('click', hideDeleteButton);
                    }
                });
            });

            // Add click event to delete button
            newCard.querySelector('.delete-course-btn').addEventListener('click', function() {
                cardsContainer.removeChild(newCard);
                updateCalendar();
                saveToLocalStorage();
            });

            updateCalendar();
            saveToLocalStorage();
        });

        document.getElementById('device-select').addEventListener('change', function() {
            const deviceSelect = document.getElementById('device-select');
            const widthInput = document.getElementById('calendar-width');
            const heightInput = document.getElementById('calendar-height');
            const selectedValue = deviceSelect.value;

            if (selectedValue === 'custom') {
                widthInput.disabled = false;
                heightInput.disabled = false;
            } else {
                const [width, height] = selectedValue.split('x');
                widthInput.value = width;
                heightInput.value = height;
                widthInput.disabled = true;
                heightInput.disabled = true;
            }

            const calendarContainer = document.getElementById('calendar-container');
            calendarContainer.style.width = widthInput.value + 'px';
            calendarContainer.style.height = heightInput.value + 'px';
            updateCalendar();
            saveToLocalStorage();
        });

        document.getElementById('calendar-width').addEventListener('input', function() {
            const width = document.getElementById('calendar-width').value;
            const calendarContainer = document.getElementById('calendar-container');
            calendarContainer.style.width = width + 'px';
            saveToLocalStorage();
        });

        document.getElementById('calendar-height').addEventListener('input', function() {
            const height = document.getElementById('calendar-height').value;
            const calendarContainer = document.getElementById('calendar-container');
            calendarContainer.style.height = height + 'px';
            updateCalendar();
            saveToLocalStorage();
        });

        document.getElementById('override-days-checkbox').addEventListener('change', function() {
            updateCalendar();
            saveToLocalStorage();
        });

        // Load device options from external file
        fetch('device-options.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('device-select').innerHTML = data;
                loadFromLocalStorage();
            });

        document.getElementById('toggle-main-container-btn').addEventListener('click', function() {
            const mainContainer = document.getElementById('main-container');
            const icon = this.querySelector('.plus-icon');
            if (mainContainer.style.display === 'none' || !mainContainer.style.display) {
                mainContainer.style.display = 'block';
                icon.textContent = 'Ã—';
                icon.style.color = 'red';
            } else {
                mainContainer.style.display = 'none';
                icon.textContent = '+';
                icon.style.color = 'black';
            }
        });

        // Ensure the main container is initially hidden
        document.getElementById('main-container').style.display = 'none';

        document.getElementById('add-term-btn').addEventListener('click', function() {
            const tableBody = document.querySelector('.term-details tbody');
            const newRow = document.createElement('tr');
            const termCount = tableBody.rows.length + 1;
            newRow.innerHTML = `
                <td>${termCount}</td>
                <td class="start-date"><input type="month" placeholder="Start Date"></td>
                <td class="end-date"><input type="month" placeholder="End Date"></td>
                <td class="units"><input type="number" step="0.01" placeholder="Units"></td>
                <td class="gpa"><input type="number" step="0.01" placeholder="GPA"></td>
            `;
            tableBody.appendChild(newRow);
            addContextMenuListener(newRow);
            const programType = document.getElementById('program-type').value;
            addRow(programType, termCount);
            applyColumnVisibility();
        });

        function applyColumnVisibility() {
            const termColumnsChecklist = document.getElementById('term-columns-checklist');
            const courseColumnsChecklists = document.querySelectorAll('.course-columns-checklist');

            termColumnsChecklist.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                const columnClass = checkbox.value;
                const isChecked = checkbox.checked;
                document.querySelectorAll(`.${columnClass}`).forEach(cell => {
                    cell.style.display = isChecked ? '' : 'none';
                });
            });

            courseColumnsChecklists.forEach(checklist => {
                checklist.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    const columnClass = checkbox.value;
                    const isChecked = checkbox.checked;
                    document.querySelectorAll(`.${columnClass}`).forEach(cell => {
                        cell.style.display = isChecked ? '' : 'none';
                    });
                });
            });
        }

        document.getElementById('edit-term-columns-btn').addEventListener('click', () => {
            const termColumnsChecklist = document.getElementById('term-columns-checklist');
            termColumnsChecklist.style.display = termColumnsChecklist.style.display === 'none' ? 'block' : 'none';
        });

        document.addEventListener('click', (event) => {
            const termColumnsChecklist = document.getElementById('term-columns-checklist');
            const editTermColumnsBtn = document.getElementById('edit-term-columns-btn');
            if (!editTermColumnsBtn.contains(event.target) && !termColumnsChecklist.contains(event.target)) {
                termColumnsChecklist.style.display = 'none';
            }
        });

        document.getElementById('term-columns-checklist').addEventListener('change', applyColumnVisibility);

        // Ensure course tables are created for existing terms on page load
        document.addEventListener('DOMContentLoaded', function() {
            const termRows = document.querySelectorAll('.term-details tbody tr');
            termRows.forEach((row, index) => {
                const termNumber = index + 1;
            });
            applyColumnVisibility();
        });

        function addContextMenuListener(row) {
            row.addEventListener('contextmenu', function(event) {
                event.preventDefault();
                removeExistingInsertButton();
                const insertBtn = document.createElement('button');
                insertBtn.textContent = 'Insert Term';
                insertBtn.className = 'insert-term-btn';
                insertBtn.style.position = 'absolute';
                insertBtn.style.top = `${event.clientY}px`;
                insertBtn.style.left = `${event.clientX}px`;
                document.body.appendChild(insertBtn);

                const gapRow = document.createElement('tr');
                gapRow.className = 'gap-row';
                gapRow.innerHTML = `<td colspan="4" style="height: 20px; background-color: #f9f9f9;"></td>`;
                row.parentNode.insertBefore(gapRow, row.nextSibling);

                insertBtn.style.top = `${gapRow.getBoundingClientRect().top + window.scrollY}px`;
                insertBtn.style.left = `${gapRow.getBoundingClientRect().left + window.scrollX}px`;

                insertBtn.addEventListener('click', function() {
                    const newRow = document.createElement('tr');
                    const termCount = document.querySelector('.term-details tbody').rows.length;
                    newRow.innerHTML = `
                        <td>${termCount}</td>
                        <td><input type="month" placeholder="Start Date"></td>
                        <td><input type="month" placeholder="End Date"></td>
                        <td><input type="number" step="0.01" placeholder="GPA"></td>
                    `;
                    row.parentNode.insertBefore(newRow, gapRow);
                    updateTermNumbers();
                    addContextMenuListener(newRow);
                    document.body.removeChild(insertBtn);
                    row.parentNode.removeChild(gapRow);
                });

                document.addEventListener('click', function() {
                    if (document.body.contains(insertBtn)) {
                        document.body.removeChild(insertBtn);
                    }
                    if (row.parentNode.contains(gapRow)) {
                        row.parentNode.removeChild(gapRow);
                    }
                }, { once: true });
            });
        }

        function removeExistingInsertButton() {
            const existingBtn = document.querySelector('.insert-term-btn');
            if (existingBtn) {
                document.body.removeChild(existingBtn);
            }
            const existingGapRow = document.querySelector('.gap-row');
            if (existingGapRow) {
                existingGapRow.parentNode.removeChild(existingGapRow);
            }
        }

        document.querySelectorAll('.term-details tbody tr').forEach(row => {
            addContextMenuListener(row);
        });

        function updateTermNumbers() {
            const rows = document.querySelectorAll('.term-details tbody tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        }

        document.querySelectorAll('#program-name, #program-code').forEach(div => {
            div.addEventListener('dblclick', function() {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = div.textContent.trim();
                input.placeholder = div.getAttribute('placeholder');
                input.style.fontSize = window.getComputedStyle(div).fontSize;
                input.style.fontWeight = window.getComputedStyle(div).fontWeight;
                div.textContent = '';
                div.appendChild(input);
                input.focus();

                input.addEventListener('blur', function() {
                    div.textContent = input.value.trim() || input.placeholder;
                    div.removeChild(input);
                });

                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        input.blur();
                    }
                });
            });
        });

        document.querySelectorAll('.course-card').forEach(card => {
            card.addEventListener('contextmenu', function(event) {
                event.preventDefault();
                const deleteBtn = card.querySelector('.delete-course-btn');
                deleteBtn.style.display = 'block';

                document.addEventListener('click', function hideDeleteButton(e) {
                    if (!card.contains(e.target)) {
                        deleteBtn.style.display = 'none';
                        document.removeEventListener('click', hideDeleteButton);
                    }
                });
            });
        });

        function makeCourseCardEditable(card) {
            card.querySelectorAll('.editable').forEach(div => {
                div.addEventListener('dblclick', function() {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = div.textContent.trim();
                    input.placeholder = div.getAttribute('data-placeholder');
                    input.style.fontSize = window.getComputedStyle(div).fontSize;
                    input.style.fontWeight = window.getComputedStyle(div).fontWeight;
                    div.textContent = '';
                    div.appendChild(input);
                    input.focus();

                    input.addEventListener('blur', function() {
                        div.textContent = input.value.trim() || input.placeholder;
                        div.removeChild(input);
                    });

                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            input.blur();
                        }
                    });
                });
            });

            card.addEventListener('contextmenu', function(event) {
                event.preventDefault();
                const deleteBtn = card.querySelector('.delete-course-btn');
                deleteBtn.style.display = 'block';

                document.addEventListener('click', function hideDeleteButton(e) {
                    if (!card.contains(e.target)) {
                        deleteBtn.style.display = 'none';
                        document.removeEventListener('click', hideDeleteButton);
                    }
                });
            });

            card.querySelector('.delete-course-btn').addEventListener('click', function() {
                card.parentNode.removeChild(card);
                updateCalendar();
                saveToLocalStorage();
            });
        }

        document.querySelectorAll('.course-card').forEach(card => {
            makeCourseCardEditable(card);
        });

        document.getElementById('add-course-btn').addEventListener('click', function() {
            const cardsContainer = document.getElementById('course-cards-container');
            const uniqueId = Date.now();
            const newCard = document.createElement('div');
            newCard.className = 'course-card';
            newCard.innerHTML = `
                <div class="course-details">
                    <div class="course-code-section">
                        <div class="editable course-code" data-placeholder="Enter course code"></div>
                        <div class="editable course-section" data-placeholder="Enter course section"></div>
                    </div>
                    <div class="editable" data-placeholder="Enter course title"></div>
                    <div class="editable" data-placeholder="Enter location"></div>
                    <div class="editable" data-placeholder="Enter grade"></div>
                    <div class="editable" data-placeholder="Enter unit"></div>
                </div>
                <div class="schedule-details">
                    <div class="days-checkboxes">
                        <input type="checkbox" id="sunday-${uniqueId}" name="days" value="Sunday"><label for="sunday-${uniqueId}">Su</label>
                        <input type="checkbox" id="monday-${uniqueId}" name="days" value="Monday"><label for="monday-${uniqueId}">M</label>
                        <input type="checkbox" id="tuesday-${uniqueId}" name="days" value="Tuesday"><label for="tuesday-${uniqueId}">Tu</label>
                        <input type="checkbox" id="wednesday-${uniqueId}" name="days" value="Wednesday"><label for="wednesday-${uniqueId}">W</label>
                        <input type="checkbox" id="thursday-${uniqueId}" name="days" value="Thursday"><label for="thursday-${uniqueId}">Th</label>
                        <input type="checkbox" id="friday-${uniqueId}" name="days" value="Friday"><label for="friday-${uniqueId}">F</label>
                        <input type="checkbox" id="saturday-${uniqueId}" name="days" value="Saturday"><label for="saturday-${uniqueId}">Sa</label>
                    </div>
                    <div>
                        <label><input type="checkbox" id="same-time-checkbox-${uniqueId}"> Same time for all days</label>
                    </div>
                    <div id="time-inputs-${uniqueId}" class="time-inputs"></div>
                </div>
                <button class="delete-course-btn">Delete</button>
            `;
            cardsContainer.appendChild(newCard);
            makeCourseCardEditable(newCard);
            updateCalendar();
            saveToLocalStorage();
        });

        document.addEventListener('DOMContentLoaded', function() {
            const tabLinks = document.querySelectorAll('.tab-link');
            const tabContents = document.querySelectorAll('.tab-content');

            function showTab(tabId) {
                tabContents.forEach(content => {
                    content.style.display = content.id === tabId ? 'block' : 'none';
                });
                tabLinks.forEach(link => {
                    link.classList.toggle('active', link.getAttribute('data-tab') === tabId);
                });
            }

            tabLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    showTab(tabId);
                });
            });

            // Show the first tab by default
            showTab('home');
        });

        let currentTimezone = 'UTC';

        function updateTimeAndDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'short', day: 'numeric', timeZone: currentTimezone };
            const dayOptions = { weekday: 'short', timeZone: currentTimezone };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: currentTimezone };
            document.getElementById('current-time').textContent = now.toLocaleTimeString(undefined, timeOptions);
            document.getElementById('current-date').textContent = now.toLocaleDateString(undefined, options);
            document.getElementById('current-day').textContent = now.toLocaleDateString(undefined, dayOptions);
            updateCurrentWeekNumber(now);
            updateTimeLeft();
        }

        function updateCurrentWeekNumber(currentDate) {
            const weekTableBody = document.querySelector('#week-table tbody');
            const weekRows = weekTableBody.querySelectorAll('tr');
            let currentWeekNumber = 'Break';

            weekRows.forEach(row => {
                const weekNo = row.cells[0].textContent.trim();
                const startDate = new Date(row.querySelector('.week-start').value);
                const endDate = new Date(row.querySelector('.week-end').value);

                if (currentDate >= startDate && currentDate <= endDate) {
                    currentWeekNumber = weekNo;
                }
            });

            document.getElementById('week-number').textContent = currentWeekNumber;
        }

        function updateTimeLeft() {
            const now = new Date();
            const requirementsTableBody = document.querySelector('#requirements-table tbody');
            const requirementRows = requirementsTableBody.querySelectorAll('tr');

            requirementRows.forEach(row => {
                const dueDateInput = row.querySelector('.due-date');
                const dueTimeInput = row.querySelector('input[placeholder="Due Time"]');
                const timeLeftCell = row.querySelector('.time-left');
                const statusSelect = row.querySelector('select');

                if (dueDateInput && dueTimeInput && timeLeftCell && statusSelect) {
                    const dueDate = new Date(dueDateInput.value);
                    const dueTime = dueTimeInput.value;
                    let timeLeftText = '';

                    if (statusSelect.value === 'In-Progress') {
                        if (!dueDateInput.value) {
                            timeLeftText = '';
                        } else {
                            const [dueHours, dueMinutes] = dueTime.split(':').map(Number);
                            const dueDateTime = new Date(dueDate);
                            dueDateTime.setHours(dueHours, dueMinutes);

                            if (dueDateTime < now) {
                                timeLeftText = 'OVERDUE';
                            } else if (dueDate.toDateString() === now.toDateString()) {
                                const diffMs = dueDateTime - now;
                                if (diffMs <= 0) {
                                    timeLeftText = 'OVERDUE';
                                } else {
                                    const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                                    const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                                    timeLeftText = `${diffHrs} h ${diffMins} min`;
                                }
                            } else {
                                const diffDays = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                                timeLeftText = `${diffDays} days`;
                            }
                        }
                    }

                    timeLeftCell.textContent = timeLeftText;
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateTimeAndDate();
            setInterval(updateTimeAndDate, 1000);

            const tabLinks = document.querySelectorAll('.tab-link');
            const tabContents = document.querySelectorAll('.tab-content');

            function showTab(tabId) {
                tabContents.forEach(content => {
                    content.style.display = content.id === tabId ? 'block' : 'none';
                });
            }

            tabLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    showTab(tabId);
                });
            });

            // Show the first tab by default
            showTab('home');

            const currentTimeDateDiv = document.getElementById('current-time-date');
            const timezoneSelector = document.getElementById('timezone-selector');

            currentTimeDateDiv.addEventListener('contextmenu', function(event) {
                event.preventDefault();
                timezoneSelector.style.display = 'block';
                timezoneSelector.style.top = `${event.clientY}px`;
                timezoneSelector.style.left = `${event.clientX}px`;
            });

            document.addEventListener('click', function(event) {
                if (!timezoneSelector.contains(event.target) && event.target !== currentTimeDateDiv) {
                    timezoneSelector.style.display = 'none';
                }
            });

            document.getElementById('timezone').addEventListener('change', function() {
                currentTimezone = this.value;
                updateTimeAndDate();
                timezoneSelector.style.display = 'none';
            });

            // Load timezone options from external file
            fetch('timezone-options.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('timezone').innerHTML = data;
                });
        });

        // Pomodoro Timer functionality
        let timerInterval;
        const timerDisplay = document.getElementById('timer');
        const startTimerBtn = document.getElementById('start-timer-btn');
        const resetTimerBtn = document.getElementById('reset-timer-btn');
        let timerDuration = 25 * 60; // 25 minutes in seconds

        function updateTimerDisplay() {
            const minutes = Math.floor(timerDuration / 60);
            const seconds = timerDuration % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function startTimer() {
            if (timerInterval) return;
            timerInterval = setInterval(() => {
                if (timerDuration > 0) {
                    timerDuration--;
                    updateTimerDisplay();
                } else {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    alert('Time is up!');
                }
            }, 1000);
        }

        function resetTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
            timerDuration = 25 * 60;
            updateTimerDisplay();
        }

        startTimerBtn.addEventListener('click', startTimer);
        resetTimerBtn.addEventListener('click', resetTimer);

        // Block Sites functionality
        const blockSitesBtn = document.getElementById('block-sites-btn');
        const blockedSitesInput = document.getElementById('blocked-sites');

        blockSitesBtn.addEventListener('click', () => {
            const blockedSites = blockedSitesInput.value.split(',').map(site => site.trim());
            blockedSites.forEach(site => {
                if (site) {
                    const regex = new RegExp(`^https?://(www\\.)?${site.replace('.', '\\.')}`);
                    chrome.tabs.query({}, tabs => {
                        tabs.forEach(tab => {
                            if (regex.test(tab.url)) {
                                chrome.tabs.remove(tab.id);
                            }
                        });
                    });
                }
            });
        });

        // Term Columns Edit functionality
        const editTermColumnsBtn = document.getElementById('edit-term-columns-btn');
        const termColumnsChecklist = document.getElementById('term-columns-checklist');

        editTermColumnsBtn.addEventListener('click', () => {
            termColumnsChecklist.style.display = termColumnsChecklist.style.display === 'none' ? 'block' : 'none';
        });

        document.addEventListener('click', (event) => {
            if (!editTermColumnsBtn.contains(event.target) && !termColumnsChecklist.contains(event.target)) {
                termColumnsChecklist.style.display = 'none';
            }
        });

        termColumnsChecklist.addEventListener('change', (event) => {
            const columnClass = event.target.value;
            const isChecked = event.target.checked;
            document.querySelectorAll(`.${columnClass}`).forEach(cell => {
                cell.style.display = isChecked ? '' : 'none';
            });
        });

        // Ensure course tables are created for existing terms on page load
        document.addEventListener('DOMContentLoaded', function() {
            const termRows = document.querySelectorAll('.term-details tbody tr');
            termRows.forEach((row, index) => {
                const termNumber = index + 1;
            });
            applyColumnVisibility();
        });

        // Add Week functionality
        document.getElementById('add-week-btn').addEventListener('click', function() {
            const weekTableBody = document.querySelector('#week-table tbody');
            const newRow = document.createElement('tr');
            const weekCount = weekTableBody.rows.length + 1;
            newRow.innerHTML = `
                <td>${weekCount}</td>
                <td><input type="date" class="week-start"></td>
                <td><input type="date" class="week-end"></td>
            `;
            weekTableBody.appendChild(newRow);
        });

        // Add Requirement functionality
        document.getElementById('add-requirement-btn').addEventListener('click', function() {
            const requirementsTableBody = document.querySelector('#requirements-table tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <select>
                        <option value="In-Progress">In-Progress</option>
                        <option value="Done">Done</option>
                    </select>
                </td>
                <td><input type="text" placeholder="Course Code"></td>
                <td><input type="text" placeholder="Requirement"></td>
                <td><input type="text" placeholder="Description"></td>
                <td><input type="date" class="due-date" placeholder="Due Date"></td>
                <td class="day"></td>
                <td><input type="time" placeholder="Start Time"></td>
                <td><input type="time" placeholder="Due Time"></td>
                <td class="time-left"></td>
            `;
            requirementsTableBody.appendChild(newRow);

            // Add event listener to update the "Day" column based on the "Due Date" input
            newRow.querySelector('.due-date').addEventListener('input', function() {
                const dueDate = new Date(this.value);
                const dayCell = newRow.querySelector('.day');
                const options = { weekday: 'short' };
                dayCell.textContent = dueDate.toLocaleDateString(undefined, options);
            });

            // Add event listener to update the "Time Left" column based on the "Due Date" and "Due Time" inputs
            newRow.querySelector('.due-date').addEventListener('input', updateTimeLeft);
            newRow.querySelector('input[placeholder="Due Time"]').addEventListener('input', updateTimeLeft);
        });

        document.getElementById('add-academic-period-btn').addEventListener('click', function() {
            const container = document.getElementById('academic-periods-container');
            const periodCount = container.children.length + 1;
            const periodId = `period-${Date.now()}`;
            const newPeriod = document.createElement('div');
            newPeriod.className = 'academic-period';
            newPeriod.innerHTML = `
                <div class="period-header">
                    <h3>Academic Period ${periodCount}</h3>
                    <button class="delete-period-btn">Delete</button>
                </div>
                <nav>
                    <ul>
                        <li><a href="#${periodId}-calendar" class="tab-link" data-tab="${periodId}-calendar">Academic Calendar</a></li>
                        <li><a href="#${periodId}-courses" class="tab-link" data-tab="${periodId}-courses">Courses</a></li>
                    </ul>
                </nav>
                <div class="tab-content" id="${periodId}-calendar">
                    <h3>Academic Calendar</h3>
                    <table class="week-table">
                        <thead>
                            <tr>
                                <th>Week No.</th>
                                <th>Start</th>
                                <th>End</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td><input type="date" class="week-start"></td>
                                <td><input type="date" class="week-end"></td>
                            </tr>
                            <!-- Additional rows can be added dynamically -->
                        </tbody>
                    </table>
                    <button class="add-week-btn">Add Week</button>
                </div>
                <div class="tab-content" id="${periodId}-courses">
                    <h3>Courses</h3>
                    <table class="courses-table">
                        <thead>
                            <tr>
                                <th>Course Code</th>
                                <th>Course Title</th>
                                <th>Course Section</th>
                                <th>Professor</th>
                                <th>Units</th>
                                <th>Grade</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="text" class="course-code" placeholder="Course Code"></td>
                                <td class="course-title"></td>
                                <td><input type="text" placeholder="Course Section"></td>
                                <td><input type="text" placeholder="Professor"></td>
                                <td class="units"></td>
                                <td><input type="number" step="0.01" placeholder="Grade"></td>
                            </tr>
                            <!-- Additional rows can be added dynamically -->
                        </tbody>
                    </table>
                    <button class="add-course-btn">Add Course</button>
                </div>
            `;
            container.appendChild(newPeriod);

            // Add event listeners to the new tabs
            newPeriod.querySelectorAll('.tab-link').forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    showTab(tabId, newPeriod);
                });
            });

            // Show the first tab by default
            showTab(`${periodId}-calendar`, newPeriod);

            // Add event listener to delete button
            newPeriod.querySelector('.delete-period-btn').addEventListener('click', function() {
                container.removeChild(newPeriod);
                updatePeriodNumbers();
            });

            // Add event listener to add week button
            newPeriod.querySelector('.add-week-btn').addEventListener('click', function() {
                const weekTableBody = newPeriod.querySelector('.week-table tbody');
                const newRow = document.createElement('tr');
                const weekCount = weekTableBody.rows.length + 1;
                newRow.innerHTML = `
                    <td>${weekCount}</td>
                    <td><input type="date" class="week-start"></td>
                    <td><input type="date" class="week-end"></td>
                `;
                weekTableBody.appendChild(newRow);
            });

            // Add event listener to add course button
            newPeriod.querySelector('.add-course-btn').addEventListener('click', function() {
                const coursesTableBody = newPeriod.querySelector('.courses-table tbody');
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td><input type="text" class="course-code" placeholder="Course Code"></td>
                    <td class="course-title"></td>
                    <td><input type="text" placeholder="Course Section"></td>
                    <td><input type="text" placeholder="Professor"></td>
                    <td class="units"></td>
                    <td><input type="number" step="0.01" placeholder="Grade"></td>
                `;
                coursesTableBody.appendChild(newRow);

                // Add event listener to populate course title and units based on course code
                newRow.querySelector('.course-code').addEventListener('input', function() {
                    const courseCode = this.value.trim();
                    const courseTitleCell = newRow.querySelector('.course-title');
                    const unitsCell = newRow.querySelector('.units');
                    const courseInfo = getCourseInfo(courseCode);
                    courseTitleCell.textContent = courseInfo.title || '';
                    unitsCell.textContent = courseInfo.units || '';
                });
            });

            // Add event listener to populate course title and units based on course code for the initial row
            newPeriod.querySelector('.course-code').addEventListener('input', function() {
                const courseCode = this.value.trim();
                const courseTitleCell = newPeriod.querySelector('.course-title');
                const unitsCell = newPeriod.querySelector('.units');
                const courseInfo = getCourseInfo(courseCode);
                courseTitleCell.textContent = courseInfo.title || '';
                unitsCell.textContent = courseInfo.units || '';
            });
        });

        function getCourseInfo(courseCode) {
            const courseTable = document.querySelector('#program-flowchart table');
            const rows = courseTable.querySelectorAll('tbody tr');
            for (const row of rows) {
                const codeCell = row.querySelector('.course-code');
                if (codeCell && codeCell.textContent.trim() === courseCode) {
                    const titleCell = row.querySelector('.course-title');
                    const unitsCell = row.querySelector('.units');
                    return {
                        title: titleCell ? titleCell.textContent.trim() : '',
                        units: unitsCell ? unitsCell.textContent.trim() : ''
                    };
                }
            }
            return {};
        }

        function showTab(tabId, periodElement) {
            periodElement.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = content.id === tabId ? 'block' : 'none';
            });
            periodElement.querySelectorAll('.tab-link').forEach(link => {
                link.classList.toggle('active', link.getAttribute('data-tab') === tabId);
            });
        }

        function updatePeriodNumbers() {
            const periods = document.querySelectorAll('.academic-period');
            periods.forEach((period, index) => {
                period.querySelector('h3').textContent = `Academic Period ${index + 1}`;
            });
        }

        document.getElementById('add-all-courses-btn').addEventListener('click', function() {
            const coursesTableBody = document.querySelector('#course-tables-container tbody');
            const newRow = document.createElement('tr');
            const previousCourses = Array.from(coursesTableBody.querySelectorAll('tr')).map(row => row.querySelector('.course-code').value);

            newRow.innerHTML = `
                <td><input type="text" class="term-taken" placeholder="Term Taken"></td>
                <td><input type="text" class="flowchart" placeholder="Flowchart"></td>
                <td><input type="text" class="course-code" placeholder="Course Code"></td>
                <td><input type="text" class="course-title" placeholder="Course Title"></td>
                <td><input type="number" class="units" step="0.01" placeholder="Units"></td>
                <td>
                    <select class="pre-requisites">
                        <option value="">None</option>
                        ${previousCourses.map(course => `<option value="${course}">${course}</option>`).join('')}
                    </select>
                </td>
            `;
            coursesTableBody.appendChild(newRow);
        });

        // Ensure the pre-requisites dropdown is updated when a new course is added
        document.querySelector('#course-tables-container tbody').addEventListener('DOMNodeInserted', function(event) {
            const rows = Array.from(document.querySelectorAll('#course-tables-container tbody tr'));
            rows.forEach((row, index) => {
                const preReqSelect = row.querySelector('.pre-requisites');
                const previousCourses = rows.slice(0, index).map(r => r.querySelector('.course-code').value);
                preReqSelect.innerHTML = `
                    <option value="">None</option>
                    ${previousCourses.map(course => `<option value="${course}">${course}</option>`).join('')}
                `;
            });
        });
    </script>
</body>
</html>